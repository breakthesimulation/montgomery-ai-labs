<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500" rel="stylesheet">
  <title>Screener | Montgomery AI</title>
  <link rel="stylesheet" href="/styles/apple.css">
  <meta name="api-key" content="3d79d057a66e65a870a114ac10cd895c">
  <style>
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
  </style>
</head>
<body>
  <nav style="position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);border-bottom:1px solid var(--glass-border);">
    <div style="max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;">
      <a href="/index.html" style="font-weight:700;font-size:1.1rem;">ğŸ§  Montgomery AI</a>
      <div style="display:flex;gap:8px;">
        <a href="/dashboard.html" class="nav-link">Dashboard</a>
        <a href="/screener.html" class="nav-link active">Screener</a>
        <a href="/risk.html" class="nav-link">Risk</a>
      </div>
    </div>
  </nav>

  <div style="padding:80px 20px 20px;max-width:1200px;margin:0 auto;">
    <header class="header">
      <h2>ğŸ” Screener</h2>
      <span class="text-sm text-muted" id="time"></span>
    </header>

    <!-- Filters -->
    <div class="glass" style="padding:16px;margin-bottom:16px;">
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="filter('ALL')">ALL</button>
        <button class="btn btn-secondary" onclick="filter('BUY')">BUY</button>
        <button class="btn btn-secondary" onclick="filter('SELL')">SELL</button>
        <button class="btn btn-secondary" onclick="filter('HIGH')">HIGH CONF</button>
      </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="glass" style="padding:40px;">
      <div class="skeleton" style="height:400px;"></div>
    </div>

    <!-- Error -->
    <div id="error" class="glass" style="display:none;padding:60px;text-align:center;">
      <div style="font-size:3rem;margin-bottom:16px;">âš ï¸</div>
      <p class="text-muted" style="margin-bottom:16px;">Failed to load signals</p>
      <button class="btn btn-secondary" onclick="load()">Retry</button>
    </div>

    <!-- Empty -->
    <div id="empty" class="glass" style="display:none;padding:60px;text-align:center;">
      <div style="font-size:3rem;margin-bottom:16px;">ğŸ”</div>
      <p class="text-muted">No signals found</p>
    </div>

    <!-- Table -->
    <div id="content" class="glass" style="overflow:hidden;display:none;">
      <table>
        <thead>
          <tr><th>Coin</th><th>Price</th><th>24h</th><th>RSI</th><th>Signal</th><th>Score</th><th>MACD</th></tr>
        <tbody id="screener"></tbody>
      </table>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="/index.html">ğŸ </a>
    <a href="/dashboard.html">ğŸ“Š</a>
    <a href="/screener.html" class="active">ğŸ”</a>
  </nav>

  <script>
    const raoulWatch = ['SOL', 'BTC', 'ETH', 'JUP'];
const benWatch = ['SOL', 'ETH'];
    const API_KEY = '3d79d057a66e65a870a114ac10cd895c';
    let allData = [];
    let currentFilter = 'ALL';
    let changeCache = null;

    document.getElementById('time').textContent = new Date().toLocaleTimeString();

    async function get24hChanges() {
      if (changeCache) return changeCache;
      try {
        const resp = await fetch('https://api.binance.com/api/v3/ticker/24hr');
        const data = await resp.json();
        const changes = {};
        data.forEach(t => changes[t.symbol.replace('USDT', '')] = parseFloat(t.priceChangePercent));
        changeCache = changes;
        return changes;
      } catch(e) { return {}; }
    }

    async function load() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('content').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('empty').style.display = 'none';

      try {
        const [signals, funding] = await Promise.all([
          fetch('/api/quality?key=' + API_KEY).then(r => r.json()),
          fetch('/api/funding?key=' + API_KEY).then(r => r.json())
        ]);

        const changes = await get24hChanges();
        const fundMap = {};
        (funding.rates || []).forEach(f => fundMap[f.coin] = f.rate_pct);

        allData = (signals.signals || []).map(s => ({
          coin: s.coin, rsi: s.rsi, signal: s.action, score: s.score,
          macd: s.macd_signal || 'neutral',
          funding: fundMap[s.coin] || 0,
          change24h: changes[s.coin] || 0,
          price: 0
        }));

        // Fetch prices
        try {
          const priceRes = await fetch('/api/prices?key=' + API_KEY);
          const prices = (await priceRes.json()).prices || [];
          prices.forEach(p => {
            const d = allData.find(x => x.coin === p.coin);
            if (d) d.price = p.price;
          });
        } catch(e) {}

        document.getElementById('loading').style.display = 'none';
        
        if (!allData.length) {
          document.getElementById('empty').style.display = 'block';
          return;
        }
        
        render();
        document.getElementById('content').style.display = 'block';
      } catch(e) {
        console.error(e);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    function filter(type) {
      currentFilter = type;
      document.querySelectorAll('.btn').forEach(b => { b.classList.remove('btn-primary'); b.classList.add('btn-secondary'); });
      event.target.classList.remove('btn-secondary'); event.target.classList.add('btn-primary');
      render();
    }

    function render() {
      let data = allData;
      if (currentFilter === 'BUY') data = data.filter(d => d.signal === 'BUY');
      else if (currentFilter === 'SELL') data = data.filter(d => d.signal === 'SELL');
      else if (currentFilter === 'HIGH') data = data.filter(d => d.score >= 70);
      data.sort((a, b) => b.score - a.score);

      if (!data.length) {
        document.getElementById('empty').style.display = 'block';
        document.getElementById('content').style.display = 'none';
        return;
      }

      document.getElementById('empty').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      const rows = data.map(d => `
        <tr>
          <td style="font-weight:600;">${d.coin}</td>
          <td class="mono">$${d.price.toFixed(2)}</td>
          <td class="mono ${d.change24h >= 0 ? 'text-green' : 'text-red'}">${d.change24h >= 0 ? '+' : ''}${d.change24h.toFixed(1)}%</td>
          <td class="mono">${d.rsi?.toFixed(0) || '--'}</td>
          <td><span class="tag ${d.signal === 'BUY' ? 'buy' : 'sell'}">${d.signal}</span></td>
          <td class="mono" style="font-weight:600;">${d.score}</td>
          <td>${d.macd === 'bullish' ? 'ğŸ“ˆ' : d.macd === 'bearish' ? 'ğŸ“‰' : 'â€”'}</td>
        </tr>
      `).join('');

      document.getElementById('screener').innerHTML = rows;
    }

    load();
    setInterval(load, 30000);
  
  // RSI Chart
  let chart, rsiSeries;
  
  function initChart() {
    chart = LightweightCharts.createChart(document.getElementById('rsi-chart'), {
      width: document.getElementById('rsi-chart').offsetWidth,
      height: 300,
      layout: { background: { type: 'solid', color: '#1C1C1E' }, textColor: '#8E8E93' },
      grid: { vertLines: { color: '#2C2C2E' }, horzLines: { color: '#2C2C2E' } },
      timeScale: { timeVisible: true },
    });
    
    rsiSeries = chart.addLineSeries({ color: '#0A84FF', lineWidth: 2 });
    
    // Add buy/sell markers
    chart.subscribeClick(param => {
      if (param.point && param.time) {
        console.log('Clicked at:', param.time, param.point.y);
      }
    });
  }
  
  async function loadRSIChart() {
    const coin = document.getElementById('chart-coin').value;
    
    // Load RSI data (would be from API in production)
    // For demo, generate sample data
    const data = [];
    const now = Math.floor(Date.now() / 1000);
    let rsi = 50;
    
    for (let i = 30; i >= 0; i--) {
      rsi += (Math.random() - 0.5) * 10;
      rsi = Math.max(20, Math.min(80, rsi));
      data.push({ time: now - i * 3600, value: rsi });
    }
    
    if (!chart) initChart();
    rsiSeries.setData(data);
    
    // Add overbought/oversold lines
    chart.addLineSeries({ color: 'rgba(255, 69, 58, 0.3)', lineWidth: 1, priceLineVisible: false })
      .setData(data.map(d => ({ time: d.time, value: 70 })));
    chart.addLineSeries({ color: 'rgba(48, 209, 88, 0.3)', lineWidth: 1, priceLineVisible: false })
      .setData(data.map(d => ({ time: d.time, value: 30 })));
  }
  
  // Load on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => setTimeout(loadRSIChart, 500));
  } else {
    setTimeout(loadRSIChart, 500);
  }

  
    async function loadRSIDetail() {
      const coin = document.getElementById('rsi-coin').value;
      
      // Load sparkline data
      try {
        const histRes = await fetch('/api/signals/history?key=' + API_KEY);
        const histData = await histRes.json();
        const snapshots = histData.slice(-20) || [];
        
        const sparkline = document.getElementById('rsi-sparkline');
        sparkline.innerHTML = snapshots.map(s => {
          const sig = (s.signals || []).find(x => x.coin === coin);
          const rsi = sig?.rsi || 50;
          const color = rsi < 35 ? 'var(--green)' : rsi > 65 ? 'var(--red)' : 'var(--text-tertiary)';
          return '<div style="width:6px;height:' + (rsi * 0.4) + 'px;background:' + color + ';border-radius:2px;"></div>';
        }).join('');
        
        // Add reference lines
        sparkline.innerHTML += '<div style="position:absolute;bottom:14px;left:0;right:0;height:1px;background:var(--glass-border);border-top:1px dashed var(--text-tertiary);"></div>';
      } catch(e) {}
      
      try {
        const [qRes, pRes] = await Promise.all([
          fetch('/api/quality?key=' + API_KEY),
          fetch('/api/prices?key=' + API_KEY)
        ]);
        const quality = await qRes.json();
        const prices = await pRes.json();
        
        const sig = (quality.signals || []).find(s => s.coin === coin);
        const price = (prices.prices || []).find(p => p.coin === coin);
        
        if (sig) {
          const rsi = sig.rsi || 50;
          const el = document.getElementById('rsi-value');
          el.textContent = rsi.toFixed(1);
          el.style.color = rsi < 35 ? 'var(--green)' : rsi > 65 ? 'var(--red)' : 'var(--text-primary)';
        }
        
        if (price) {
          document.getElementById('rsi-change').textContent = (price.change_24h_pct >= 0 ? '+' : '') + price.change_24h_pct.toFixed(1) + '%';
        }
        
        document.getElementById('rsi-detail').style.display = 'block';
      } catch(e) {}
    }

  </script>

    <!-- RSI Chart Section -->
    <div class="glass" style="margin: 16px;">
      <h3 style="padding: 16px; border-bottom: 1px solid var(--glass-border); margin: 0;">
        ğŸ“ˆ RSI History
        <select id="chart-coin" onchange="loadRSIChart()" style="margin-left: 12px; padding: 6px; background: var(--bg-tertiary); border: none; border-radius: 6px; color: var(--text-primary);">
          <option value="SOL">SOL</option>
          <option value="BTC">BTC</option>
          <option value="ETH">ETH</option>
        </select>
      </h3>
      <div id="rsi-chart" style="height: 300px; padding: 16px;"></div>
    </div>


  <!-- RSI Detail Panel -->
  <div id="rsi-detail" class="glass" style="margin: 16px; display: none;">
    <h3 style="padding: 16px; border-bottom: 1px solid var(--glass-border);">
      RSI Detail
      <select id="rsi-coin" onchange="loadRSIDetail()" style="margin-left: 12px; padding: 6px;">
        <option value="SOL">SOL</option>
        <option value="BTC">BTC</option>
        <option value="ETH">ETH</option>
      </select>
    </h3>
    <div style="padding: 16px;">
      <div style="display: flex; gap: 24px; margin-bottom: 16px;">
        <div><div id="rsi-value" style="font-size: 2rem; font-weight: 700;">--</div><div style="font-size: 0.8rem; color: var(--text-tertiary);">RSI</div></div>
        <div><div id="rsi-change" style="font-size: 1.5rem;">--</div><div style="font-size: 0.8rem; color: var(--text-tertiary);">24h %</div></div>
        <div><div id="rsi-score" style="font-size: 1.5rem;">--</div><div style="font-size: 0.8rem; color: var(--text-tertiary);">Score</div></div>
      </div>
      <div id="rsi-sparkline" style="display: flex; align-items: flex-end; gap: 2px; height: 40px;"></div>
    </div>
  </div>

</body>
</html>
