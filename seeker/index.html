<!DOCTYPE html>
<html lang="en">
<head>
  <style>body{background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,sans-serif;margin:0}.glass{background:#1C1C1E;border-radius:12px;padding:16px;margin:0 16px 16px}.btn{padding:12px 20px;border-radius:8px;border:none;font-weight:600;cursor:pointer}.btn-primary{background:#0A84FF;color:#fff}.btn-secondary{background:#2C2C2E;color:#fff}.text-muted{color:#8E8E93}.text-sm{font-size:0.85rem}@media(max-width:600px){.grid{grid-template-columns:1fr!important}}</style>
  <meta charset="UTF-8">
  meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Seeker">
  <link rel="apple-touch-icon" href="/seeker/icons/icon-192.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta property="og:title" content="Solana Seeker">
  <meta property="og:description" content="Your Solana news hub - AI-curated daily digests">
  <meta property="og:image" content="/seeker/seeker-og.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”®</text></svg>">
  <title>Solana Seeker</title>
  <meta name="description" content="Your Solana news digest">
  <meta name="theme-color" content="#0A84FF">
  <link rel="manifest" href="/seeker/manifest.json">
  <link rel="stylesheet" href="/seeker/styles.css">
  <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('/seeker/sw.js');
    async function loadPrices() {
      try {
        const res = await fetch('/api/prices?key=' + API_KEY);
        const data = await res.json();
        const coins = ['SOL', 'JUP', 'JTO', 'BONK', 'RAY'];
        const prices = (data.prices || []).filter(p => coins.includes(p.coin));
        
        if (!prices.length) return;
        
        document.getElementById('price-ticker').innerHTML = prices.map(p => {
          const ch = p.change_24h_pct || 0;
          const color = ch >= 0 ? 'var(--green)' : 'var(--red)';
          const arrow = ch >= 0 ? 'â–²' : 'â–¼';
          return '<span style="margin:0 16px;font-size:0.8rem;font-family:monospace;">' + p.coin + ' $' + p.price.toFixed(2) + ' <span style="color:' + color + ';">' + arrow + Math.abs(ch).toFixed(1) + '%</span></span>';
        }).join('') + '<span style="margin:0 16px;font-size:0.8rem;">â€¢ SOL $' + (prices.find(p=>p.coin==='SOL')?.price || 0).toFixed(2) + '</span>';
      } catch(e) { console.log(e); }
    }
    loadPrices();
    checkPriceAlerts();
    setInterval(loadPrices, 30000);

  
    // Reading mode
    function showReadingMode(id) {
      const article = allArticles.find(a => a.id === id);
      if (!article) return;
      
      const sheet = document.createElement('div');
      sheet.id = 'reading-sheet';
      sheet.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:300;padding:20px;padding-top:60px;overflow-y:auto;';
      sheet.innerHTML = `
        <button onclick="this.closest('#reading-sheet').remove()" style="position:absolute;top:20px;right:20px;background:none;border:none;color:white;font-size:1.5rem;">âœ•</button>
        <div style="font-family:Georgia,serif;font-size:1.3rem;line-height:1.7;color:white;max-width:600px;margin:0 auto;">
          <h2 style="font-size:1.5rem;margin-bottom:16px;font-weight:700;">highlightTokens(article.title)</h2>
          <p style="color:var(--text-secondary);margin-bottom:16px;">${article.source} Â· ${article.category}</p>
          <div style="margin-top:24px;font-size:1.1rem;">${article.content || article.teaser}</div>
        </div>
        <div style="position:fixed;bottom:0;left:0;right:0;padding:16px;background:rgba(0,0,0,0.95);display:flex;gap:12px;border-top:1px solid var(--glass-border);">
          <button onclick="toggleSave('${article.id}')" style="flex:1;padding:12px;background:var(--bg-secondary);border:none;border-radius:8px;color:white;">ğŸ“– Save</button>
          <button onclick="navigator.clipboard.writeText('${article.url}');alert('Link copied!')" style="flex:1;padding:12px;background:var(--accent);border:none;border-radius:8px;color:white;">ğŸ“¤ Share</button>
        </div>
      `;
      document.body.appendChild(sheet);
    }

  
    // Live time updates
    setInterval(() => {
      document.querySelectorAll('.time-ago').forEach(el => {
        const ts = el.dataset.ts;
        if (ts) el.textContent = timeAgo(ts);
      });
    }, 60000);

  
    // Detect tokens in headlines and make them tappable
    function highlightTokens(text) {
      const tokens = ['$SOL', '$JUP', '$BONK', '$RAY', '$JTO', '$MNGO', '$STSOL', '$MSOL'];
      let result = text;
      tokens.forEach(t => {
        const regex = new RegExp('(' + t.replace('$', '\$') + ')', 'gi');
        result = result.replace(regex, '<span onclick="showTokenPopup('' + t.replace('$','') + '')" style="background:var(--accent);color:white;padding:2px 6px;border-radius:4px;font-size:0.8rem;cursor:pointer;">$1</span>');
      });
      return result;
    }
    
    function showTokenPopup(token) {
      const prices = window.priceCache || {};
      const p = prices[token] || {};
      const price = p.price || '--';
      const ch = p.change_24h_pct || 0;
      alert(token + ': $' + price + ' (' + (ch>=0?'+':'') + ch.toFixed(1) + '%)');
    }

  
    // Price alerts check
    async function checkPriceAlerts() {
      try {
        const res = await fetch('/api/prices?key=' + API_KEY);
        const data = await res.json();
        const prices = data.prices || [];
        
        const alerts = JSON.parse(localStorage.getItem('price_alerts') || '[]');
        for (const a of alerts) {
          if (a.triggered) continue;
          const p = prices.find(p => p.coin === a.coin);
          if (!p) continue;
          
          const triggered = (a.direction === 'above' && p.price > a.price) || 
                          (a.direction === 'below' && p.price < a.price);
          if (triggered) {
            a.triggered = true;
            localStorage.setItem('price_alerts', JSON.stringify(alerts));
            showAlertBanner(a.coin + ' hit $' + a.price);
          }
        }
      } catch(e) {}
    }
    
    function showAlertBanner(msg) {
      const banner = document.createElement('div');
      banner.id = 'alert-banner';
      banner.style = 'position:fixed;top:60px;left:0;right:0;background:linear-gradient(90deg,#FF453A,#FF6961);color:white;padding:12px 16px;text-align:center;font-weight:600;z-index:100;cursor:pointer;';
      banner.textContent = 'ğŸš¨ ' + msg;
      banner.onclick = () => banner.remove();
      document.body.appendChild(banner);
      playChime();
    }

  
    // Unread badges
    function updateBadges() {
      const lastVisit = parseInt(localStorage.getItem('seeker_last_visit') || '0');
      const currentArticles = allArticles.length;
      const savedCount = (JSON.parse(localStorage.getItem('saved_articles') || []).length;
      
      // Unread = new articles since last visit
      const lastCount = parseInt(localStorage.getItem('seeker_article_count') || '0');
      const unread = Math.max(0, currentArticles - lastCount);
      
      // Save count
      document.getElementById('badge-saved')?.setAttribute('data-count', savedCount);
      document.getElementById('badge-feed')?.setAttribute('data-count', unread);
      
      // Breaking alerts
      const breaking = allArticles.filter(a => a.breaking).length;
      document.getElementById('badge-alerts')?.setAttribute('data-count', breaking);
      
      // Store for next visit
      localStorage.setItem('seeker_article_count', currentArticles);
      localStorage.setItem('seeker_last_visit', Date.now());
    }
    
    // Badge CSS
    const style = document.createElement('style');
    style.textContent = `
      .badge { position: relative; }
      .badge::after {
        content: attr(data-count);
        position: absolute;
        top: -4px;
        right: -8px;
        background: #FF453A;
        color: white;
        font-size: 0.6rem;
        padding: 2px 5px;
        border-radius: 10px;
        display: inline-block;
      }
      .badge[data-count="0"]::after { display: none; }
    `;
    document.head.appendChild(style);

  
    function toggleTheme() {
      const isDark = document.body.classList.contains('dark');
      document.body.classList.toggle('dark');
      localStorage.setItem('seeker_theme', isDark ? 'light' : 'dark');
      document.querySelector('button[onclick="toggleTheme()"]').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    // Apply saved theme
    if (localStorage.getItem('seeker_theme') === 'light') {
      document.body.classList.remove('dark');
    }

  
    const STOPWORDS = new Set(['the','a','an','of','in','to','for','with','on','at','is','are','was','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','shall','can','need','dare','ought','used','get','got','going','go','went','come','came','make','made','take','took','give','gave','say','said','tell','told']);
    function updateTrending() {
      const articles = window.allArticles || [];
      const kw = {};
      articles.forEach(a => {
        const words = (a.title + ' ' + (a.teaser || '')).toLowerCase().split(/\s+/);
        words.forEach(w => {
          if (w.length > 3 && !STOPWORDS.has(w) && w.length <= 20) {
            kw[w] = (kw[w] || 0) + 1;
          }
        });
      });
      const top = Object.entries(kw).filter(x => x[1] >= 2).sort((a,b) => b[1] - a[1]).slice(0, 8);
      document.getElementById('trending-chips').innerHTML = top.map(t => 
        '<span onclick="filterByKeyword(\''+t[0]+'\')" style="display:inline-block;padding:4px 10px;background:var(--bg-tertiary);border-radius:12px;font-size:0.8rem;margin-right:6px;cursor:pointer;">'+t[0]+'</span>'
      ).join('');
    }
    function filterByKeyword(kw) {
      const filtered = (window.allArticles || []).filter(a => (a.title + a.teaser).toLowerCase().includes(kw));
      renderFeed(filtered);
    }

  </script>
</head>
<body>
  <button onclick="toggleTheme()" style="position:fixed;top:12px;right:12px;background:none;border:none;font-size:1.2rem;z-index:100;">ğŸŒ™</button>
  <header class="page-header">  <!-- Price Ticker -->
  <div id="price-ticker" style="background:var(--bg-secondary);padding:8px 0;overflow-x:auto;white-space:nowrap;border-bottom:1px solid var(--glass-border);display:flex;">
    <span style="margin:0 16px;font-size:0.8rem;">Loading prices...</span>
  </div>
    <h1>ğŸ”¥ Solana Seeker</h1>
    <span onclick="toggleSearch()" style="cursor:pointer;font-size:1.2rem;">ğŸ”</span>
  </header>

  <!-- Search Bar -->
  <div id="search-bar" style="display:none;padding:12px;background:var(--bg-primary);border-bottom:1px solid var(--glass-border);">
    <input type="text" id="search-input" placeholder="Search articles..." 
           style="width:100%;padding:12px;border-radius:8px;background:var(--bg-secondary);border:1px solid var(--glass-border);color:var(--text-primary);font-size:1rem;">
    <div id="search-history" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;"></div>
  </div>

  <!-- Category Filter -->
  <div class="category-filter">
    <button class="chip active" data-category="all">All</button>
    <button class="chip" data-category="watching">ğŸ‘ï¸ Watching</button>
    <button class="chip" data-category="DeFi">DeFi</button>
    <button class="chip" data-category="NFT">NFT</button>
    <button class="chip" data-category="Validator">Validator</button>
    <button class="chip" data-category="Dev">Dev</button>
    <button class="chip" data-category="Market">Market</button>
  </div>

  <!-- Trending Topics -->
    <!-- Just In Section -->
  <div id="just-in" style="padding:12px;background:var(--bg-secondary);border-bottom:1px solid var(--glass-border);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-weight:700;">âš¡ Just In</span>
      <span class="text-xs text-muted" id="just-in-time"></span>
    </div>
    <div id="just-in-scroll" style="display:flex;gap:12px;overflow-x:auto;padding-bottom:4px;-webkit-overflow-scrolling:touch;"></div>
  </div>

  <div id="trending-bar" style="padding:8px 16px;background:var(--bg-secondary);border-bottom:1px solid var(--glass-border);display:flex;gap:8px;overflow-x:auto;">
    <span class="text-xs text-muted" style="white-space:nowrap;">Trending:</span>
    <div id="trending-chips" style="display:flex;gap:6px;"></div>
  </div>

  <!-- New Stories Pill -->
  <div id="new-stories" class="new-stories-pill" onclick="showNewStories()" style="display:none;">
    ğŸ†• <span id="new-count">0</span> new
  </div>

  <!-- Breaking Alert -->
  <div id="breaking-alert" class="breaking-alert" style="display:none;" onclick="dismissBreaking()">
    <span>ğŸš¨</span> <span id="breaking-text">Breaking</span>
  </div>

  <!-- Feed -->
  
    <div id="catchup-banner" style="display:none;background:linear-gradient(90deg,var(--blue),#5E5CE6);padding:16px;color:white;border-radius:12px;margin:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <strong>Welcome back!</strong>
          <p style="margin:4px 0 0;font-size:0.85rem;opacity:0.9;">You've missed X stories while away</p>
        </div>
        <button onclick="dismissCatchup()" style="background:none;border:none;color:white;font-size:1.5rem;cursor:pointer;">âœ•</button>
      </div>
    </div>


  <!-- Trending Topics -->
  <div id="trending-section" style="padding: 12px 16px; overflow-x: auto; white-space: nowrap; border-bottom: 1px solid var(--glass-border);">
    <span style="font-size: 0.85rem; color: var(--text-tertiary); margin-right: 8px;">ğŸ”¥</span>
    <span id="trending-chips"></span>
  </div>

<div id="feed"></div>

  <!-- Loading -->
  <div id="loading">
    <div class="skeleton skeleton-card"></div>
    <div class="skeleton skeleton-card"></div>
    <div class="skeleton skeleton-card"></div>
  </div>

  <div id="error" style="display:none;padding:40px;text-align:center;">
    <p style="margin-bottom:16px;">Failed to load</p>
    <button class="btn btn-secondary" onclick="loadFeed()">Retry</button>
  </div>

  <nav class="bottom-nav">
    <a href="/seeker/index.html" class="active"><span>ğŸ </span>{${t('nav.feed')}}</a>
    <a href="/seeker/digest.html"><span>ğŸ””</span>Digest</a>
    <a href="/seeker/notifications.html"><span>ğŸ“£</span>Alerts</a>
    <a href="/seeker/saved.html"><span>ğŸ”–</span>Saved</a>
  </nav>

  <script>
    const API_KEY = '3d79d057a66e65a870a114ac10cd895c';
    let allArticles = [];

    // Cache for speed
    function getCached(key) {
      try { return JSON.parse(localStorage.getItem('seeker_' + key)); } catch { return null; }
    }
    function setCache(key, val) { try { localStorage.setItem('seeker_' + key, JSON.stringify({val:val, time:Date.now()})); } catch {} }
    
    // Show cached immediately, then update
    const cached = getCached('feed');
    if (cached && cached.val && cached.time && Date.now() - cached.time < 300000) {
      allArticles = cached.val;
      render();
    }

    let currentPage = 1;
    let trackView(currentCategory); localStorage.setItem("seeker_last_category", e.target.dataset.category); currentCategory = 'all';
    let searchQuery = '';
    let saved = JSON.parse(localStorage.getItem('saved_articles') || '[]');
    let ptrStart = 0, ptrY = 0, isPulling = false;

    // Stopwords for trending
    const STOPWORDS = new Set(['the','a','an','and','or','but','in','on','at','to','for','of','is','are','was','were','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','shall','can','need','dare','ought','used','it','its','this','that','these','those','i','you','he','she','we','they','what','which','who','whom','whose','where','when','why','how','all','each','every','both','few','more','most','other','some','such','no','nor','not','only','own','same','so','than','too','very','just','also']);

    function timeAgo(ts) {
      const s = Math.floor((Date.now() - new Date(ts)) / 1000);
      if (s < 60) return 'just now';
      if (s < 3600) return Math.floor(s/60) + 'm ago';
      if (s < 86400) return Math.floor(s/3600) + 'h ago';
      return Math.floor(s/86400) + 'd ago';
    }

    function getSentimentDot(s) {
      const c = {positive:'#30D158',negative:'#FF453A',neutral:'#8E8E93'}[s]||'#8E8E93';
      return `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${c};margin-right:6px;"></span>`;
    }

    function toggleSearch() {
      const bar = document.getElementById('search-bar');
      bar.style.display = bar.style.display === 'none' ? 'block' : 'none';
      if (bar.style.display === 'block') {
        document.getElementById('search-input').focus();
        renderSearchHistory();
      }
    }

    function renderSearchHistory() {
      const hist = JSON.parse(localStorage.getItem('seeker_search_history') || '[]').slice(0, 5);
      document.getElementById('search-history').innerHTML = hist.map(q => 
        `<span onclick="search('${q}')" style="font-size:0.75rem;padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;cursor:pointer;">${q}</span>`
      ).join('');
    }

    function search(q) {
      searchQuery = q.toLowerCase();
      document.getElementById('search-input').value = q;
      
      // Save to history
      let hist = JSON.parse(localStorage.getItem('seeker_search_history') || '[]');
      if (!hist.includes(q)) { hist.unshift(q); hist = hist.slice(0, 5); localStorage.setItem('seeker_search_history', JSON.stringify(hist)); }
      
      currentPage = 1;
      render();
    }

    function calcTrending() {
      const words = {};
      allArticles.forEach(a => {
        const txt = (a.title + ' ' + (a.teaser || '')).toLowerCase().replace(/[^a-z0-9]/g, ' ');
        txt.split(/\s+/).forEach(w => {
          if (w.length > 3 && !STOPWORDS.has(w)) words[w] = (words[w] || 0) + 1;
        });
      });
      const top = Object.entries(words).sort((a,b) => b[1]-a[1]).slice(0, 8).map(x => x[0]);
      document.getElementById('trending-chips').innerHTML = top.map(t => 
        `<span onclick="search('${t}')" style="font-size:0.7rem;padding:3px 8px;background:var(--accent);color:white;border-radius:8px;cursor:pointer;">#${t}</span>`
      ).join('');
    }

    function toggleSave(id, e) {
      e.preventDefault(); e.stopPropagation();
      saved = saved.includes(id) ? saved.filter(s => s !== id) : [...saved, id];
      localStorage.setItem('saved_articles', JSON.stringify(saved));
      render();
    }

    
    function getRecommendations() {
      const saved = JSON.parse(localStorage.getItem('saved_articles') || '[]');
      if (saved.length < 3) return null;
      
      // Get categories from saved
      const catCounts = {};
      allArticles.forEach(a => { if (saved.includes(a.id)) catCounts[a.category] = (catCounts[a.category] || 0) + 1; });
      
      const total = Object.values(catCounts).reduce((a,b)=>a+b, 0);
      const weights = {};
      for (const cat in catCounts) weights[cat] = catCounts[cat] / total;
      
      // Score articles
      const scored = allArticles.map(a => {
        let score = (weights[a.category] || 0) * 100;
        // Recency boost
        const hours = (Date.now() - new Date(a.published)) / 3600000;
        score += Math.max(0, 20 - hours);
        return {...a, _score: score};
      });
      
      return scored.sort((a,b) => b._score - a._score).slice(0, 5);
    }

    
    function getForYou() {
      const weights = JSON.parse(localStorage.getItem('seeker_weights') || '{}');
      if (!Object.keys(weights).length) return allArticles;
      
      return allArticles.map(a => {
        const w = weights[a.category] || 0;
        const hours = (Date.now() - new Date(a.published)) / 3600000;
        const recency = Math.max(0, 20 - hours) / 20;
        return {...a, _score: w * 3 + recency};
      }).sort((a,b) => b._score - a._score);
    }

    function render() {
      let filtered = currentCategory === 'all' ? allArticles : allArticles.filter(a => a.category === currentCategory);
      
      // Apply search
      if (searchQuery) {
        filtered = filtered.filter(a => 
          a.title.toLowerCase().includes(searchQuery) || 
          (a.teaser || '').toLowerCase().includes(searchQuery) ||
          a.category.toLowerCase().includes(searchQuery)
        );
      }
      
      const display = filtered.slice(0, currentPage * 20);
      
      if (!display.length && currentPage === 1) {
        document.getElementById('feed').innerHTML = '<p style="text-align:center;padding:40px;color:var(--text-muted);">No articles</p>';
        return;
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';

      document.getElementById('feed').innerHTML = display.map(article => `
        <a href="/seeker/article.html?id=${article.id}" class="news-card ${article.breaking?'breaking':''}">
          ${article.image ? `<img class="hero-image" src="${article.image}" alt="" loading="lazy" onerror="this.style.display='none'" style="filter:blur(10px);transition:filter 0.3s" onload="this.style.filter='blur(0)'">` : ''}
          <div class="content">
            <div class="header">
              <div class="source">${article.breaking?'<span style="color:#FF453A;font-weight:700;">ğŸš¨ </span>':''}<span>${article.source}</span></div>
              <span class="bookmark" onclick="toggleSave('${article.id}', event)">${saved.includes(article.id)?'â˜…':'â˜†'}</span><span onclick="showReadingMode('${article.id}')" style="cursor:pointer;margin-left:8px;">ğŸ“–</span>
            </div>
            <div class="headline">highlightTokens(article.title)</div>
            <div class="teaser">${getSentimentDot(article.sentiment)}${article.teaser||''}</div>
            <div class="footer">
              <span class="time">${timeAgo(article.published)} â€¢ ${article.reading_time||2}m</span>
              <span class="category">${article.category}</span>
            </div>
          </div>
        </a>
      `).join('');

      document.getElementById('load-more').style.display = filtered.length > currentPage * 20 ? 'block' : 'none';
      
      const breaking = filtered.find(a => a.breaking);
      if (breaking) {
        document.getElementById('breaking-alert').style.display = 'flex';
        document.getElementById('breaking-text').textContent = breaking.title.slice(0,40)+'...';
      }
    }

    async function loadFeed(refresh = false) {
      if (!refresh) { document.getElementById('loading').style.display = 'block'; document.getElementById('feed').innerHTML = ''; }
      document.getElementById('error').style.display = 'none';

      try {
        const res = await fetch('/api/seeker/feed?key=' + API_KEY);
        const data = await res.json();
        allArticles = data.articles || [];
      setCache("feed", allArticles);
        currentPage = 1;
        render();
        calcTrending();
    loadJustIn();
      } catch(e) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    function showNewStories() {
      document.getElementById('new-stories').style.display = 'none';
      window.scrollTo(0,0);
    }

    function dismissBreaking() { document.getElementById('breaking-alert').style.display = 'none'; }
    function loadMore() { currentPage++; render(); }

    // Search input
    document.getElementById('search-input').addEventListener('input', e => {
      searchQuery = e.target.value.toLowerCase();
      currentPage = 1;
      render();
    });

    // Category filter
    document.querySelector('.category-filter').addEventListener('click', e => {
      if (e.target.classList.contains('chip')) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        e.target.classList.add('active');
        trackView(currentCategory); localStorage.setItem("seeker_last_category", e.target.dataset.category); currentCategory = e.target.dataset.category;
        currentPage = 1;
        render();
      }
    });

    // Pull to refresh
    document.addEventListener('touchstart', e => { if (window.scrollY===0) { ptrStart = e.touches[0].clientY; isPulling = true; }});
    document.addEventListener('touchmove', e => { if (isPulling && window.scrollY===0) { ptrY = e.touches[0].clientY - ptrStart; }});
    document.addEventListener('touchend', e => { if (isPulling && ptrY > 60) loadFeed(true); isPulling=false; ptrY=0; });

    // Infinite scroll
    let st; window.addEventListener('scroll', () => { clearTimeout(st); st = setTimeout(() => { if ((innerHeight+scrollY)/document.body.offsetHeight > 0.8) loadMore(); }, 100); });

    loadPrices();
    checkPriceAlerts();
    
    // Filter memory - restore last category
    const savedCat = localStorage.getItem('seeker_last_category');
    if (savedCat) {
      localStorage.setItem("seeker_last_category", e.target.dataset.category); currentCategory = savedCat;
      document.querySelectorAll('.chip').forEach(c => {
        if (c.dataset.category === savedCat) c.classList.add('active');
        else c.classList.remove('active');
      });
    }

    loadFeed();
    checkCatchup();
    updateBadges();
    setInterval(loadFeed, 1800000);
    setInterval(loadJustIn, 60000);
  
    async function loadPrices() {
      try {
        const res = await fetch('/api/prices?key=' + API_KEY);
        const data = await res.json();
        const coins = ['SOL', 'JUP', 'JTO', 'BONK', 'RAY'];
        const prices = (data.prices || []).filter(p => coins.includes(p.coin));
        
        if (!prices.length) return;
        
        document.getElementById('price-ticker').innerHTML = prices.map(p => {
          const ch = p.change_24h_pct || 0;
          const color = ch >= 0 ? 'var(--green)' : 'var(--red)';
          const arrow = ch >= 0 ? 'â–²' : 'â–¼';
          return '<span style="margin:0 16px;font-size:0.8rem;font-family:monospace;">' + p.coin + ' $' + p.price.toFixed(2) + ' <span style="color:' + color + ';">' + arrow + Math.abs(ch).toFixed(1) + '%</span></span>';
        }).join('') + '<span style="margin:0 16px;font-size:0.8rem;">â€¢ SOL $' + (prices.find(p=>p.coin==='SOL')?.price || 0).toFixed(2) + '</span>';
      } catch(e) { console.log(e); }
    }
    loadPrices();
    checkPriceAlerts();
    setInterval(loadPrices, 30000);

  
    // Reading mode
    function showReadingMode(id) {
      const article = allArticles.find(a => a.id === id);
      if (!article) return;
      
      const sheet = document.createElement('div');
      sheet.id = 'reading-sheet';
      sheet.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.98);z-index:300;padding:20px;padding-top:60px;overflow-y:auto;';
      sheet.innerHTML = `
        <button onclick="this.closest('#reading-sheet').remove()" style="position:absolute;top:20px;right:20px;background:none;border:none;color:white;font-size:1.5rem;">âœ•</button>
        <div style="font-family:Georgia,serif;font-size:1.3rem;line-height:1.7;color:white;max-width:600px;margin:0 auto;">
          <h2 style="font-size:1.5rem;margin-bottom:16px;font-weight:700;">highlightTokens(article.title)</h2>
          <p style="color:var(--text-secondary);margin-bottom:16px;">${article.source} Â· ${article.category}</p>
          <div style="margin-top:24px;font-size:1.1rem;">${article.content || article.teaser}</div>
        </div>
        <div style="position:fixed;bottom:0;left:0;right:0;padding:16px;background:rgba(0,0,0,0.95);display:flex;gap:12px;border-top:1px solid var(--glass-border);">
          <button onclick="toggleSave('${article.id}')" style="flex:1;padding:12px;background:var(--bg-secondary);border:none;border-radius:8px;color:white;">ğŸ“– Save</button>
          <button onclick="navigator.clipboard.writeText('${article.url}');alert('Link copied!')" style="flex:1;padding:12px;background:var(--accent);border:none;border-radius:8px;color:white;">ğŸ“¤ Share</button>
        </div>
      `;
      document.body.appendChild(sheet);
    }

  
    // Live time updates
    setInterval(() => {
      document.querySelectorAll('.time-ago').forEach(el => {
        const ts = el.dataset.ts;
        if (ts) el.textContent = timeAgo(ts);
      });
    }, 60000);

  
    // Detect tokens in headlines and make them tappable
    function highlightTokens(text) {
      const tokens = ['$SOL', '$JUP', '$BONK', '$RAY', '$JTO', '$MNGO', '$STSOL', '$MSOL'];
      let result = text;
      tokens.forEach(t => {
        const regex = new RegExp('(' + t.replace('$', '\$') + ')', 'gi');
        result = result.replace(regex, '<span onclick="showTokenPopup('' + t.replace('$','') + '')" style="background:var(--accent);color:white;padding:2px 6px;border-radius:4px;font-size:0.8rem;cursor:pointer;">$1</span>');
      });
      return result;
    }
    
    function showTokenPopup(token) {
      const prices = window.priceCache || {};
      const p = prices[token] || {};
      const price = p.price || '--';
      const ch = p.change_24h_pct || 0;
      alert(token + ': $' + price + ' (' + (ch>=0?'+':'') + ch.toFixed(1) + '%)');
    }

  
    // Price alerts check
    async function checkPriceAlerts() {
      try {
        const res = await fetch('/api/prices?key=' + API_KEY);
        const data = await res.json();
        const prices = data.prices || [];
        
        const alerts = JSON.parse(localStorage.getItem('price_alerts') || '[]');
        for (const a of alerts) {
          if (a.triggered) continue;
          const p = prices.find(p => p.coin === a.coin);
          if (!p) continue;
          
          const triggered = (a.direction === 'above' && p.price > a.price) || 
                          (a.direction === 'below' && p.price < a.price);
          if (triggered) {
            a.triggered = true;
            localStorage.setItem('price_alerts', JSON.stringify(alerts));
            showAlertBanner(a.coin + ' hit $' + a.price);
          }
        }
      } catch(e) {}
    }
    
    function showAlertBanner(msg) {
      const banner = document.createElement('div');
      banner.id = 'alert-banner';
      banner.style = 'position:fixed;top:60px;left:0;right:0;background:linear-gradient(90deg,#FF453A,#FF6961);color:white;padding:12px 16px;text-align:center;font-weight:600;z-index:100;cursor:pointer;';
      banner.textContent = 'ğŸš¨ ' + msg;
      banner.onclick = () => banner.remove();
      document.body.appendChild(banner);
      playChime();
    }

  
    // Unread badges
    function updateBadges() {
      const lastVisit = parseInt(localStorage.getItem('seeker_last_visit') || '0');
      const currentArticles = allArticles.length;
      const savedCount = (JSON.parse(localStorage.getItem('saved_articles') || []).length;
      
      // Unread = new articles since last visit
      const lastCount = parseInt(localStorage.getItem('seeker_article_count') || '0');
      const unread = Math.max(0, currentArticles - lastCount);
      
      // Save count
      document.getElementById('badge-saved')?.setAttribute('data-count', savedCount);
      document.getElementById('badge-feed')?.setAttribute('data-count', unread);
      
      // Breaking alerts
      const breaking = allArticles.filter(a => a.breaking).length;
      document.getElementById('badge-alerts')?.setAttribute('data-count', breaking);
      
      // Store for next visit
      localStorage.setItem('seeker_article_count', currentArticles);
      localStorage.setItem('seeker_last_visit', Date.now());
    }
    
    // Badge CSS
    const style = document.createElement('style');
    style.textContent = `
      .badge { position: relative; }
      .badge::after {
        content: attr(data-count);
        position: absolute;
        top: -4px;
        right: -8px;
        background: #FF453A;
        color: white;
        font-size: 0.6rem;
        padding: 2px 5px;
        border-radius: 10px;
        display: inline-block;
      }
      .badge[data-count="0"]::after { display: none; }
    `;
    document.head.appendChild(style);

  
    function toggleTheme() {
      const isDark = document.body.classList.contains('dark');
      document.body.classList.toggle('dark');
      localStorage.setItem('seeker_theme', isDark ? 'light' : 'dark');
      document.querySelector('button[onclick="toggleTheme()"]').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    // Apply saved theme
    if (localStorage.getItem('seeker_theme') === 'light') {
      document.body.classList.remove('dark');
    }

  
    const STOPWORDS = new Set(['the','a','an','of','in','to','for','with','on','at','is','are','was','be','been','being','have','has','had','do','does','did','will','would','could','should','may','might','must','shall','can','need','dare','ought','used','get','got','going','go','went','come','came','make','made','take','took','give','gave','say','said','tell','told']);
    function updateTrending() {
      const articles = window.allArticles || [];
      const kw = {};
      articles.forEach(a => {
        const words = (a.title + ' ' + (a.teaser || '')).toLowerCase().split(/\s+/);
        words.forEach(w => {
          if (w.length > 3 && !STOPWORDS.has(w) && w.length <= 20) {
            kw[w] = (kw[w] || 0) + 1;
          }
        });
      });
      const top = Object.entries(kw).filter(x => x[1] >= 2).sort((a,b) => b[1] - a[1]).slice(0, 8);
      document.getElementById('trending-chips').innerHTML = top.map(t => 
        '<span onclick="filterByKeyword(\''+t[0]+'\')" style="display:inline-block;padding:4px 10px;background:var(--bg-tertiary);border-radius:12px;font-size:0.8rem;margin-right:6px;cursor:pointer;">'+t[0]+'</span>'
      ).join('');
    }
    function filterByKeyword(kw) {
      const filtered = (window.allArticles || []).filter(a => (a.title + a.teaser).toLowerCase().includes(kw));
      renderFeed(filtered);
    }

  </script>

    // Onboarding overlay
    function showOnboarding() {
      if (localStorage.getItem('seeker_onboarded')) return;
      
      const steps = [
        {title: 'Your Solana News Hub', desc: 'Stay updated with everything Solana', icon: 'ğŸ”¥'},
        {title: '3 AI Digests Daily', desc: 'Morning UTC Â· New York Â· Tokyo', icon: 'ğŸ””'},
        {title: 'Install as App', desc: 'Add to home screen for quick access', icon: 'ğŸ“±'}
      ];
      let step = 0;
      
      const overlay = document.createElement('div');
      overlay.id = 'onboarding';
      overlay.style = 'position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:500;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center;';
      
      function render() {
        const s = steps[step];
        overlay.innerHTML = `
          <div style="font-size:4rem;margin-bottom:20px;">${s.icon}</div>
          <h2 style="font-size:1.5rem;margin-bottom:12px;">${s.title}</h2>
          <p style="color:var(--text-secondary);margin-bottom:40px;">${s.desc}</p>
          <div style="display:flex;gap:8px;margin-bottom:40px;">
            ${steps.map((_,i) => '<div style="width:8px;height:8px;border-radius:50%;background:'+(i===step?'var(--accent)':'var(--bg-tertiary)')+';"></div>').join('')}
          </div>
          <div style="display:flex;gap:12px;">
            <button onclick="this.closest('#onboarding').remove();localStorage.setItem('seeker_onboarded','true')" style="padding:12px 24px;background:var(--bg-tertiary);border:none;border-radius:8px;color:var(--text-secondary);">Skip</button>
            <button onclick="if(step<2){step++;render()}else{this.closest('#onboarding').remove();localStorage.setItem('seeker_onboarded','true')}" style="padding:12px 24px;background:var(--accent);border:none;border-radius:8px;color:white;font-weight:600;">${step<2?'Next':'Done'}</button>
          </div>
        `;
      }
      render();
      document.body.appendChild(overlay);
    }
    // Run onboarding
    showOnboarding();

</body>
</html>
